<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>BondRadar – Progress Tracker</title>
    <meta name="description" content="Simple progress tracker powered by a published Google Sheet." />
    <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              brand: { 500: '#6366f1', 600: '#4f46e5' }
            }
          }
        }
      }
    </script>
  </head>
  <body class="bg-slate-50 text-slate-900">
    <header class="bg-[#0b1736] text-white">
      <div class="mx-auto max-w-6xl px-4 py-5 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <img src="9fin.jpg" alt="9fin" class="h-7 w-auto rounded-md ring-1 ring-white/10 shadow-sm opacity-95" onerror="this.style.display='none'" />
          <h1 class="text-lg font-semibold tracking-tight">BondRadar · Progress Tracker</h1>
        </div>
      </div>
    </header>

    <main class="mx-auto max-w-6xl px-4 py-6">
  <!-- Controls (hidden) -->
  <section class="hidden mb-6 rounded-lg border border-slate-200 bg-white p-4 shadow-sm" aria-hidden="true">
        <label for="publishedUrl" class="block text-sm font-medium text-slate-700">Published Google Sheet URL</label>
        <input id="publishedUrl" type="text" class="mt-1 w-full rounded-md border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-200" value="https://docs.google.com/spreadsheets/d/e/2PACX-1vQgyZLZ7pfUliJwmvi9z6CzpsE1ZEm4N97Bm6JgeaELaYkDpMX-PLZnrH89w-5HT15zXJLy25mUm3dR/pubhtml?gid=0&single=true" placeholder="Paste 'Publish to web' link e.g. https://docs.google.com/spreadsheets/d/e/.../pubhtml?gid=0&single=true" />
        <div class="mt-3 flex gap-2">
          <button id="loadBtn" class="inline-flex items-center justify-center gap-2 rounded-md bg-[#00e5a8] px-4 py-2 text-sm font-medium text-[#0b1736] shadow-sm hover:bg-[#00c697] focus:outline-none focus:ring-2 focus:ring-[#86fde8]">Load</button>
        </div>
        <p class="mt-3 text-xs text-slate-500">File → Share → Publish to web → copy the link and paste above.</p>
        <div id="errorBox" class="mt-3 hidden rounded-md border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700"></div>
      </section>

      <!-- Two-column stats layout: News (left) and Quantanite (right) -->
      <section class="mb-8 grid grid-cols-1 gap-6 md:grid-cols-2">
        <!-- News (LATAM) -->
        <div class="rounded-xl border border-slate-100 bg-white p-5 shadow-md">
          <div class="mb-4 flex items-center justify-between">
            <h2 class="text-base font-semibold text-slate-800">News Progress (LATAM Companies)</h2>
            <span class="inline-flex items-center gap-1 text-[10px] font-medium rounded-full bg-green-100 text-green-700 px-2 py-0.5 border border-green-200">✅ Completed</span>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div class="rounded-lg border border-slate-100 bg-slate-50 p-3"><p class="text-[11px] uppercase tracking-wide text-slate-500">Logos Uploaded</p><p id="latamNewsLogos" class="mt-1 text-xl font-semibold text-slate-800">0</p></div>
            <div class="rounded-lg border border-slate-100 bg-slate-50 p-3"><p class="text-[11px] uppercase tracking-wide text-slate-500">Ratings Collected</p><p id="latamNewsRatings" class="mt-1 text-xl font-semibold text-slate-800">0</p></div>
            <div class="rounded-lg border border-slate-100 bg-slate-50 p-3"><p class="text-[11px] uppercase tracking-wide text-slate-500">Aliases Collected</p><p id="latamNewsAliases" class="mt-1 text-xl font-semibold text-slate-800">0</p></div>
            <div class="rounded-lg border border-slate-100 bg-slate-50 p-3"><p class="text-[11px] uppercase tracking-wide text-slate-500">Crawlers Set Up</p><p id="latamNewsCrawlers" class="mt-1 text-xl font-semibold text-slate-800">0</p></div>
          </div>
          <!-- LATAM News Completion (always 100% of 381) -->
          <div class="mt-5 space-y-3">
            <div>
              <div class="mb-1 flex items-center justify-between text-sm"><span class="text-slate-700">Logos</span><span id="latamNewsLogosPct" class="font-medium">0%</span></div>
              <div class="h-3 w-full rounded-full bg-slate-200 overflow-hidden"><div id="latamNewsLogosBar" class="h-3 rounded-full bg-gradient-to-r from-[#00e5a8] to-teal-400 transition-all" style="width:0%"></div></div>
              <div class="mt-1 text-xs text-slate-500"><span id="latamNewsLogosText">0 / 381</span></div>
            </div>
            <div>
              <div class="mb-1 flex items-center justify-between text-sm"><span class="text-slate-700">Ratings</span><span id="latamNewsRatingsPct" class="font-medium">0%</span></div>
              <div class="h-3 w-full rounded-full bg-slate-200 overflow-hidden"><div id="latamNewsRatingsBar" class="h-3 rounded-full bg-gradient-to-r from-[#00e5a8] to-teal-400 transition-all" style="width:0%"></div></div>
              <div class="mt-1 text-xs text-slate-500"><span id="latamNewsRatingsText">0 / 381</span></div>
            </div>
            <div>
              <div class="mb-1 flex items-center justify-between text-sm"><span class="text-slate-700">Aliases</span><span id="latamNewsAliasesPct" class="font-medium">0%</span></div>
              <div class="h-3 w-full rounded-full bg-slate-200 overflow-hidden"><div id="latamNewsAliasesBar" class="h-3 rounded-full bg-gradient-to-r from-[#00e5a8] to-teal-400 transition-all" style="width:0%"></div></div>
              <div class="mt-1 text-xs text-slate-500"><span id="latamNewsAliasesText">0 / 381</span></div>
            </div>
            <div>
              <div class="mb-1 flex items-center justify-between text-sm"><span class="text-slate-700">Crawlers</span><span id="latamNewsCrawlersPct" class="font-medium">0%</span></div>
              <div class="h-3 w-full rounded-full bg-slate-200 overflow-hidden"><div id="latamNewsCrawlersBar" class="h-3 rounded-full bg-gradient-to-r from-[#00e5a8] to-teal-400 transition-all" style="width:0%"></div></div>
              <div class="mt-1 text-xs text-slate-500"><span id="latamNewsCrawlersText">0 / 381</span></div>
            </div>
          </div>
        </div>
        <!-- News (IG) -->
        <div class="rounded-xl border border-slate-100 bg-white p-5 shadow-md">
          <div class="mb-4 flex items-center justify-between">
            <h2 class="text-base font-semibold text-slate-800">News Progress (IG Companies)</h2>
            <span class="text-xs text-slate-400">Live</span>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div class="rounded-lg border border-slate-100 bg-slate-50 p-3"><p class="text-[11px] uppercase tracking-wide text-slate-500">Logos Uploaded</p><p id="newsLogosSorted" class="mt-1 text-xl font-semibold text-slate-800">0</p></div>
            <div class="rounded-lg border border-slate-100 bg-slate-50 p-3"><p class="text-[11px] uppercase tracking-wide text-slate-500">Ratings Collected</p><p id="newsRatingsCollected" class="mt-1 text-xl font-semibold text-slate-800">0</p></div>
            <div class="rounded-lg border border-slate-100 bg-slate-50 p-3"><p class="text-[11px] uppercase tracking-wide text-slate-500">Aliases Collected</p><p id="newsAliasesCollected" class="mt-1 text-xl font-semibold text-slate-800">0</p></div>
            <div class="rounded-lg border border-slate-100 bg-slate-50 p-3"><p class="text-[11px] uppercase tracking-wide text-slate-500">Crawlers Set Up</p><p id="newsCrawlersSetup" class="mt-1 text-xl font-semibold text-slate-800">0</p></div>
          </div>
          <!-- News Completion (individual) -->
          <div class="mt-5 space-y-3">
            <div>
              <div class="mb-1 flex items-center justify-between text-sm"><span class="text-slate-700">Logos</span><span id="newsLogosPct" class="font-medium">0%</span></div>
              <div class="h-3 w-full rounded-full bg-slate-200 overflow-hidden"><div id="newsLogosBar" class="h-3 rounded-full bg-gradient-to-r from-[#00e5a8] to-teal-400 transition-all" style="width:0%"></div></div>
              <div class="mt-1 text-xs text-slate-500"><span id="newsLogosText">0 / 1235</span></div>
            </div>
            <div>
              <div class="mb-1 flex items-center justify-between text-sm"><span class="text-slate-700">Ratings</span><span id="newsRatingsPct" class="font-medium">0%</span></div>
              <div class="h-3 w-full rounded-full bg-slate-200 overflow-hidden"><div id="newsRatingsBar" class="h-3 rounded-full bg-gradient-to-r from-[#00e5a8] to-teal-400 transition-all" style="width:0%"></div></div>
              <div class="mt-1 text-xs text-slate-500"><span id="newsRatingsText">0 / 1235</span></div>
            </div>
            <div>
              <div class="mb-1 flex items-center justify-between text-sm"><span class="text-slate-700">Aliases</span><span id="newsAliasesPct" class="font-medium">0%</span></div>
              <div class="h-3 w-full rounded-full bg-slate-200 overflow-hidden"><div id="newsAliasesBar" class="h-3 rounded-full bg-gradient-to-r from-[#00e5a8] to-teal-400 transition-all" style="width:0%"></div></div>
              <div class="mt-1 text-xs text-slate-500"><span id="newsAliasesText">0 / 1235</span></div>
            </div>
            <div>
              <div class="mb-1 flex items-center justify-between text-sm"><span class="text-slate-700">Crawlers</span><span id="newsCrawlersPct" class="font-medium">0%</span></div>
              <div class="h-3 w-full rounded-full bg-slate-200 overflow-hidden"><div id="newsCrawlersBar" class="h-3 rounded-full bg-gradient-to-r from-[#00e5a8] to-teal-400 transition-all" style="width:0%"></div></div>
              <div class="mt-1 text-xs text-slate-500"><span id="newsCrawlersText">0 / 3705</span></div>
            </div>
          </div>
        </div>
        <!-- Quantanite -->
        <div class="rounded-xl border border-slate-100 bg-white p-5 shadow-md">
          <div class="mb-4 flex items-center justify-between">
            <h2 class="text-base font-semibold text-slate-800">Quantanite Progress</h2>
            <span class="text-xs text-slate-400">Live</span>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div class="rounded-lg border border-slate-100 bg-slate-50 p-3"><p class="text-[11px] uppercase tracking-wide text-slate-500">Documents Uploaded</p><p id="quantDocsUploaded" class="mt-1 text-xl font-semibold text-slate-800">0</p></div>
            <div class="rounded-lg border border-slate-100 bg-slate-50 p-3"><p class="text-[11px] uppercase tracking-wide text-slate-500">Companies Completed</p><p id="quantCompaniesCompleted" class="mt-1 text-xl font-semibold text-slate-800">0</p></div>
            <div class="rounded-lg border border-slate-100 bg-slate-50 p-3"><p class="text-[11px] uppercase tracking-wide text-slate-500">Logos Uploaded</p><p id="quantLogosUploaded" class="mt-1 text-xl font-semibold text-slate-800">0</p></div>
            <div class="rounded-lg border border-slate-100 bg-slate-50 p-3"><p class="text-[11px] uppercase tracking-wide text-slate-500">Documents Added to 9fin</p><p id="quantDocsAddedTo9fin" class="mt-1 text-xl font-semibold text-slate-800">0</p></div>
          </div>
          <!-- Quantanite Progress Bars: LATAM, IG, Overall -->
          <div class="mt-5 space-y-3">
            <div>
              <div class="mb-1 flex items-center justify-between text-sm"><span class="text-slate-700">LATAM</span><span id="quantLatamPct" class="font-medium">0%</span></div>
              <div class="h-3 w-full rounded-full bg-slate-200 overflow-hidden"><div id="quantLatamBar" class="h-3 rounded-full bg-gradient-to-r from-[#00e5a8] to-teal-400 transition-all" style="width:0%"></div></div>
              <div class="mt-1 text-xs text-slate-500"><span id="quantLatamText">0 / 0</span></div>
            </div>
            <div>
              <div class="mb-1 flex items-center justify-between text-sm"><span class="text-slate-700">IG</span><span id="quantIGPct" class="font-medium">0%</span></div>
              <div class="h-3 w-full rounded-full bg-slate-200 overflow-hidden"><div id="quantIGBar" class="h-3 rounded-full bg-gradient-to-r from-[#00e5a8] to-teal-400 transition-all" style="width:0%"></div></div>
              <div class="mt-1 text-xs text-slate-500"><span id="quantIGText">0 / 0</span></div>
            </div>
            <div>
              <div class="mb-1 flex items-center justify-between text-sm"><span class="text-slate-700">EM</span><span id="quantEMPct" class="font-medium">0%</span></div>
              <div class="h-3 w-full rounded-full bg-slate-200 overflow-hidden"><div id="quantEMBar" class="h-3 rounded-full bg-gradient-to-r from-[#00e5a8] to-teal-400 transition-all" style="width:0%"></div></div>
              <div class="mt-1 text-xs text-slate-500"><span id="quantEMText">0 / 0</span></div>
            </div>
            <div>
              <div class="mb-1 flex items-center justify-between text-sm"><span class="text-slate-700">CEEMEA</span><span id="quantCEEMEAPct" class="font-medium">0%</span></div>
              <div class="h-3 w-full rounded-full bg-slate-200 overflow-hidden"><div id="quantCEEMEABar" class="h-3 rounded-full bg-gradient-to-r from-[#00e5a8] to-teal-400 transition-all" style="width:0%"></div></div>
              <div class="mt-1 text-xs text-slate-500"><span id="quantCEEMEAText">0 / 0</span></div>
            </div>
            <div>
              <div class="mb-1 flex items-center justify-between text-sm"><span class="text-slate-700">APAC</span><span id="quantAPACPct" class="font-medium">0%</span></div>
              <div class="h-3 w-full rounded-full bg-slate-200 overflow-hidden"><div id="quantAPACBar" class="h-3 rounded-full bg-gradient-to-r from-[#00e5a8] to-teal-400 transition-all" style="width:0%"></div></div>
              <div class="mt-1 text-xs text-slate-500"><span id="quantAPACText">0 / 0</span></div>
            </div>
            <div>
              <div class="mb-1 flex items-center justify-between text-sm"><span class="text-slate-700">Overall</span><span id="quantOverallPct" class="font-medium">0%</span></div>
              <div class="h-3 w-full rounded-full bg-slate-200 overflow-hidden"><div id="quantOverallBar" class="h-3 rounded-full bg-gradient-to-r from-[#00e5a8] to-teal-400 transition-all" style="width:0%"></div></div>
              <div class="mt-1 text-xs text-slate-500"><span id="quantOverallText">0 / 0</span></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Weekly Companies Created (Line Chart) -->
      <section class="mb-8 rounded-xl border border-slate-100 bg-white p-5 shadow-md">
        <div class="mb-4 flex items-center justify-between">
          <h2 class="text-base font-semibold text-slate-800">Quantanite · Weekly Companies Created</h2>
          <span class="text-xs text-slate-400">Live</span>
        </div>
        <div class="h-40 sm:h-48">
    <canvas id="weeklyChart"></canvas>
        </div>
    <p id="weeklyChartNote" class="mt-3 text-xs text-slate-500">Based on Quantanite sheet (Date=A, Total Completed=C). Groups by ISO week and anchors each label to that week’s Friday; shows cumulative weekly totals over time.</p>
      </section>

      <!-- Projection to 9016 (Line Chart) -->
      <section class="mb-8 rounded-xl border border-slate-100 bg-white p-5 shadow-md">
        <div class="mb-2 flex items-center justify-between">
          <h2 class="text-base font-semibold text-slate-800">Quantanite · Projection to complete 9016 Companies</h2>
          <div class="flex items-center gap-3">
            <span class="text-xs text-slate-400">Live</span>
            <label for="teamSizeSelect" class="text-xs text-slate-600">Team size</label>
            <select id="teamSizeSelect" class="rounded-md border border-slate-300 bg-white px-2 py-1 text-xs text-slate-700 shadow-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-200">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3" selected>3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
              <option value="7">7</option>
              <option value="8">8</option>
              <option value="9">9</option>
              <option value="10">10</option>
            </select>
          </div>
        </div>
        <div class="h-40 sm:h-48">
          <canvas id="projectionChart"></canvas>
        </div>
  <p id="projectionNote" class="mt-3 text-xs text-slate-500">Assumes a constant weekly creation rate equal to the average of observed weeks, scaled by team size. Team size: <span id="projectionTeam">3</span>. Estimated completion: <span id="projectionEta">—</span></p>
      </section>
    </main>

  <footer class="mx-auto max-w-6xl px-4 py-8 text-center text-xs text-slate-400">Built with Tailwind. Data from Google Sheets.</footer>

    <script>
  const els = {
        url: document.getElementById('publishedUrl'),
        loadBtn: document.getElementById('loadBtn'),
        errorBox: document.getElementById('errorBox'),
  // Custom stats elements
  newsLogosSorted: document.getElementById('newsLogosSorted'),
  newsRatingsCollected: document.getElementById('newsRatingsCollected'),
  newsAliasesCollected: document.getElementById('newsAliasesCollected'),
  newsCrawlersSetup: document.getElementById('newsCrawlersSetup'),
  quantDocsUploaded: document.getElementById('quantDocsUploaded'),
  quantCompaniesCompleted: document.getElementById('quantCompaniesCompleted'),
  quantLogosUploaded: document.getElementById('quantLogosUploaded'),
  quantDocsAddedTo9fin: document.getElementById('quantDocsAddedTo9fin'),
  // News completion elements (individual)
  newsLogosPct: document.getElementById('newsLogosPct'),
  newsLogosBar: document.getElementById('newsLogosBar'),
  newsLogosText: document.getElementById('newsLogosText'),
  newsRatingsPct: document.getElementById('newsRatingsPct'),
  newsRatingsBar: document.getElementById('newsRatingsBar'),
  newsRatingsText: document.getElementById('newsRatingsText'),
  newsAliasesPct: document.getElementById('newsAliasesPct'),
  newsAliasesBar: document.getElementById('newsAliasesBar'),
  newsAliasesText: document.getElementById('newsAliasesText'),
  newsCrawlersPct: document.getElementById('newsCrawlersPct'),
  newsCrawlersBar: document.getElementById('newsCrawlersBar'),
  newsCrawlersText: document.getElementById('newsCrawlersText'),
  // LATAM News completion elements (always 100% of 381)
  latamNewsLogos: document.getElementById('latamNewsLogos'),
  latamNewsRatings: document.getElementById('latamNewsRatings'),
  latamNewsAliases: document.getElementById('latamNewsAliases'),
  latamNewsCrawlers: document.getElementById('latamNewsCrawlers'),
  latamNewsLogosPct: document.getElementById('latamNewsLogosPct'),
  latamNewsLogosBar: document.getElementById('latamNewsLogosBar'),
  latamNewsLogosText: document.getElementById('latamNewsLogosText'),
  latamNewsRatingsPct: document.getElementById('latamNewsRatingsPct'),
  latamNewsRatingsBar: document.getElementById('latamNewsRatingsBar'),
  latamNewsRatingsText: document.getElementById('latamNewsRatingsText'),
  latamNewsAliasesPct: document.getElementById('latamNewsAliasesPct'),
  latamNewsAliasesBar: document.getElementById('latamNewsAliasesBar'),
  latamNewsAliasesText: document.getElementById('latamNewsAliasesText'),
  latamNewsCrawlersPct: document.getElementById('latamNewsCrawlersPct'),
  latamNewsCrawlersBar: document.getElementById('latamNewsCrawlersBar'),
  latamNewsCrawlersText: document.getElementById('latamNewsCrawlersText'),
  // Quantanite progress elements
  quantLatamPct: document.getElementById('quantLatamPct'),
  quantLatamBar: document.getElementById('quantLatamBar'),
  quantLatamText: document.getElementById('quantLatamText'),
  quantIGPct: document.getElementById('quantIGPct'),
  quantIGBar: document.getElementById('quantIGBar'),
  quantIGText: document.getElementById('quantIGText'),
  quantEMPct: document.getElementById('quantEMPct'),
  quantEMBar: document.getElementById('quantEMBar'),
  quantEMText: document.getElementById('quantEMText'),
  quantCEEMEAPct: document.getElementById('quantCEEMEAPct'),
  quantCEEMEABar: document.getElementById('quantCEEMEABar'),
  quantCEEMEAText: document.getElementById('quantCEEMEAText'),
  quantAPACPct: document.getElementById('quantAPACPct'),
  quantAPACBar: document.getElementById('quantAPACBar'),
  quantAPACText: document.getElementById('quantAPACText'),
  quantOverallPct: document.getElementById('quantOverallPct'),
  quantOverallBar: document.getElementById('quantOverallBar'),
  quantOverallText: document.getElementById('quantOverallText'),
      };

  const NEWS_TOTAL = 1235; // total number of companies for News scope

      function showError(msg) {
        els.errorBox.textContent = msg;
        els.errorBox.classList.remove('hidden');
      }
      function clearError() {
        els.errorBox.textContent = '';
        els.errorBox.classList.add('hidden');
      }

      function publishedUrlToCsv(url) {
        try {
          const u = new URL(url);
          const parts = u.pathname.split('/').filter(Boolean);
          const isDE = parts[2] === 'e' && parts[1] === 'd';
          const gid = u.searchParams.get('gid') || '0';
          if (u.hostname === 'docs.google.com' && parts[0] === 'spreadsheets' && isDE) {
            const key = parts[3];
            return `https://docs.google.com/spreadsheets/d/e/${key}/pub?gid=${encodeURIComponent(gid)}&single=true&output=csv`;
          }
        } catch (e) {}
        return null;
      }

      async function fetchPublishedCsv(url, timeoutMs = 15000) {
        const csvUrl = publishedUrlToCsv(url);
        if (!csvUrl) throw new Error('Please paste a valid published Google Sheet URL.');
        const controller = new AbortController();
        const to = setTimeout(() => controller.abort(), timeoutMs);
        const res = await fetch(csvUrl, { signal: controller.signal, headers: { 'Cache-Control': 'no-cache' } });
        clearTimeout(to);
        if (!res.ok) throw new Error(`HTTP ${res.status} loading CSV`);
        return res.text();
      }

      function parseCsvLine(line) {
        const out = [];
        let cur = '';
        let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
          const ch = line[i];
          if (inQuotes) {
            if (ch === '"') {
              if (line[i + 1] === '"') { cur += '"'; i++; } else { inQuotes = false; }
            } else cur += ch;
          } else {
            if (ch === '"') inQuotes = true;
            else if (ch === ',') { out.push(cur); cur = ''; }
            else cur += ch;
          }
        }
        out.push(cur);
        return out;
      }

      function parseCsvToRows(csvText) {
        const lines = csvText.replace(/\r\n?/g, '\n').split('\n').filter(Boolean);
        if (lines.length === 0) return [];
        const headers = parseCsvLine(lines[0]).map((h) => h.toLowerCase().trim());
        const idx = {
          task: headers.findIndex((h) => /task|item|title/.test(h)),
          status: headers.findIndex((h) => /status|state/.test(h)),
          owner: headers.findIndex((h) => /owner|assignee|who/.test(h)),
          eta: headers.findIndex((h) => /eta|due|target/.test(h)),
          progress: headers.findIndex((h) => /progress|pct|percent/.test(h)),
        };
        const rows = [];
        for (let i = 1; i < lines.length; i++) {
          const cols = parseCsvLine(lines[i]);
          const get = (j) => (j >= 0 && j < cols.length ? cols[j] : '');
          rows.push({
            task: get(idx.task),
            status: get(idx.status),
            owner: get(idx.owner),
            eta: get(idx.eta),
            progress: toNumber(get(idx.progress)),
          });
        }
        return rows;
      }

      function toNumber(v) {
        if (v == null) return 0;
        if (typeof v === 'number') return v;
        const s = String(v).replace(/[^0-9.\-]/g, '');
        const n = Number(s);
        return Number.isFinite(n) ? n : 0;
      }

      function updateStats(stats) {
        const defaults = {
          newsLogosSorted: 0,
          newsRatingsCollected: 0,
          newsAliasesCollected: 0,
          newsCrawlersSetup: 0,
          quantDocsUploaded: 0,
          quantCompaniesCompleted: 0,
          quantLogosUploaded: 0,
          quantDocsAddedTo9fin: 0,
          // Quantanite totals
          quantTotalCompanies: 0, // B1
          quantLatamTotal: 0,     // B3
          quantIGTotal: 0,        // F3
          quantEMTotal: 0,        // B31
          quantCEEMEATotal: 0,    // B32
          quantAPACTotal: 0,      // B33
        };
        const s = Object.assign(defaults, stats || {});
        els.newsLogosSorted.textContent = s.newsLogosSorted;
        els.newsRatingsCollected.textContent = s.newsRatingsCollected;
        els.newsAliasesCollected.textContent = s.newsAliasesCollected;
        els.newsCrawlersSetup.textContent = s.newsCrawlersSetup;
        els.quantDocsUploaded.textContent = s.quantDocsUploaded;
        els.quantCompaniesCompleted.textContent = s.quantCompaniesCompleted;
        els.quantLogosUploaded.textContent = s.quantLogosUploaded;
        els.quantDocsAddedTo9fin.textContent = s.quantDocsAddedTo9fin;

        // Individual News completions (each out of NEWS_TOTAL)
        const clamp = (n) => Math.max(0, Math.min(NEWS_TOTAL, Number(n) || 0));
        const setBar = (val, pctEl, barEl, txtEl) => {
          const pct = NEWS_TOTAL ? Math.round((clamp(val) / NEWS_TOTAL) * 100) : 0;
          if (pctEl) pctEl.textContent = `${pct}%`;
          if (barEl) barEl.style.width = `${pct}%`;
          if (txtEl) txtEl.textContent = `${clamp(val)} / ${NEWS_TOTAL}`;
        };
        // Helper for bars with a custom total (used for IG Crawlers)
        const setBarCustomTotal = (val, total, pctEl, barEl, txtEl) => {
          const safeTotal = Math.max(0, Number(total) || 0);
          const done = Math.max(0, Math.min(safeTotal, Number(val) || 0));
          const pct = safeTotal ? Math.round((done / safeTotal) * 100) : 0;
          if (pctEl) pctEl.textContent = `${pct}%`;
          if (barEl) barEl.style.width = `${pct}%`;
          if (txtEl) txtEl.textContent = `${done} / ${safeTotal}`;
        };
        setBar(s.newsLogosSorted, els.newsLogosPct, els.newsLogosBar, els.newsLogosText);
        setBar(s.newsRatingsCollected, els.newsRatingsPct, els.newsRatingsBar, els.newsRatingsText);
        setBar(s.newsAliasesCollected, els.newsAliasesPct, els.newsAliasesBar, els.newsAliasesText);
  // IG Crawlers total is 3 × 1235 = 3705
  setBarCustomTotal(s.newsCrawlersSetup, NEWS_TOTAL * 3, els.newsCrawlersPct, els.newsCrawlersBar, els.newsCrawlersText);

        // LATAM News card: fixed at 381/381 (100%) for all four metrics
        const LATAM_NEWS_TOTAL = 381;
        const setLatam = (pctEl, barEl, txtEl) => {
          if (pctEl) pctEl.textContent = '100%';
          if (barEl) barEl.style.width = '100%';
          if (txtEl) txtEl.textContent = `${LATAM_NEWS_TOTAL} / ${LATAM_NEWS_TOTAL}`;
        };
        if (els.latamNewsLogos) els.latamNewsLogos.textContent = LATAM_NEWS_TOTAL;
        if (els.latamNewsRatings) els.latamNewsRatings.textContent = LATAM_NEWS_TOTAL;
        if (els.latamNewsAliases) els.latamNewsAliases.textContent = LATAM_NEWS_TOTAL;
        if (els.latamNewsCrawlers) els.latamNewsCrawlers.textContent = LATAM_NEWS_TOTAL;
        setLatam(els.latamNewsLogosPct, els.latamNewsLogosBar, els.latamNewsLogosText);
        setLatam(els.latamNewsRatingsPct, els.latamNewsRatingsBar, els.latamNewsRatingsText);
        setLatam(els.latamNewsAliasesPct, els.latamNewsAliasesBar, els.latamNewsAliasesText);
        setLatam(els.latamNewsCrawlersPct, els.latamNewsCrawlersBar, els.latamNewsCrawlersText);

        // Quantanite progress
        const totalCompanies = Number(s.quantTotalCompanies) || 0; // B1 (9016)
        const latamTotal = Number(s.quantLatamTotal) || 0;         // B3 (381)
        const igTotal = Number(s.quantIGTotal) || 0;               // F3 (1235)
  const companiesCompleted = Number(s.quantCompaniesCompleted) || 0; // B26
  const emTotal = Number(s.quantEMTotal) || 0;               // B31
  const ceemeaTotal = Number(s.quantCEEMEATotal) || 0;       // B32
  const apacTotal = Number(s.quantAPACTotal) || 0;           // B33

        const setBarWithTotal = (completed, total, pctEl, barEl, txtEl) => {
          const safeTotal = Math.max(0, Number(total) || 0);
          const done = Math.max(0, Math.min(safeTotal, Number(completed) || 0));
          const pct = safeTotal ? Math.round((done / safeTotal) * 100) : 0;
          if (pctEl) pctEl.textContent = `${pct}%`;
          if (barEl) barEl.style.width = `${pct}%`;
          if (txtEl) txtEl.textContent = `${done} / ${safeTotal}`;
        };

        // LATAM: 100% complete
        setBarWithTotal(latamTotal, latamTotal, els.quantLatamPct, els.quantLatamBar, els.quantLatamText);

        // IG: (Companies Completed - LATAM) / IG Total
        const igCompleted = Math.max(0, companiesCompleted - latamTotal);
        setBarWithTotal(igCompleted, igTotal, els.quantIGPct, els.quantIGBar, els.quantIGText);

  // EM / CEEMEA / APAC: 0% for now
  setBarWithTotal(0, emTotal, els.quantEMPct, els.quantEMBar, els.quantEMText);
  setBarWithTotal(0, ceemeaTotal, els.quantCEEMEAPct, els.quantCEEMEABar, els.quantCEEMEAText);
  setBarWithTotal(0, apacTotal, els.quantAPACPct, els.quantAPACBar, els.quantAPACText);

  // Overall: Companies Completed / Total Companies
        setBarWithTotal(companiesCompleted, totalCompanies, els.quantOverallPct, els.quantOverallBar, els.quantOverallText);
      }

      function getStatsFromCsv(csvText) {
        const lines = csvText.replace(/\r\n?/g, '\n').split('\n').filter(Boolean);
        if (!lines.length) return {};
        const grid = lines.map(parseCsvLine); // full grid including first row
        const headers = (grid[0] || []).map((h) => String(h).toLowerCase().trim());
        const rows = grid.slice(1);

        // Helpers to read specific cell addresses like 'F4' -> grid[3][5]
        const colLettersToIndex = (letters) => {
          let n = 0;
          for (let i = 0; i < letters.length; i++) {
            const c = letters.charCodeAt(i);
            if (c >= 65 && c <= 90) n = n * 26 + (c - 64); // 'A'..'Z'
            else if (c >= 97 && c <= 122) n = n * 26 + (c - 96); // 'a'..'z'
          }
          return n - 1; // zero-based
        };
        const getByAddress = (addr) => {
          const m = String(addr).match(/^([A-Za-z]+)(\d+)$/);
          if (!m) return undefined;
          const col = colLettersToIndex(m[1]);
          const row = parseInt(m[2], 10) - 1; // zero-based
          if (row < 0 || col < 0) return undefined;
          return (grid[row] && grid[row][col]) ?? undefined;
        };

        // Metric/Value style table support
        const metricIdx = headers.findIndex((h) => ['metric', 'name', 'stat', 'key'].includes(h));
        const valueIdx = headers.findIndex((h) => ['value', 'val', 'count', 'number'].includes(h));
        const dict = {};
        if (metricIdx !== -1 && valueIdx !== -1) {
          for (const r of rows) {
            const k = String(r[metricIdx] || '').toLowerCase().trim();
            if (!k) continue;
            dict[k] = toNumber(r[valueIdx]);
          }
        }

        const byHeader = (candidates) => {
          const idx = headers.findIndex((h) => candidates.includes(h));
          if (idx === -1) return 0;
          const val = rows[0]?.[idx] ?? 0;
          return toNumber(val);
        };
        const pick = (syns) => {
          for (const s of syns) {
            if (dict[s] != null) return dict[s];
          }
          return byHeader(syns);
        };

        // Prefer exact cell addresses, fall back to header/metric parsing
        const vOrPick = (addr, syns) => {
          const v = getByAddress(addr);
          const n = toNumber(v);
          return n || pick(syns);
        };

        return {
          // News (F4..F7)
          newsLogosSorted: vOrPick('F4', ['logos sorted','news logos sorted','logos_uploaded','logos uploaded','logos_sorted']),
          newsRatingsCollected: vOrPick('F5', ['ratings collected','news ratings collected','ratings']),
          newsAliasesCollected: vOrPick('F6', ['aliases collected','news aliases collected','aliases']),
          newsCrawlersSetup: vOrPick('F7', ['crawlers set up','crawlers setup','news crawlers set up','crawlers']),
          // Quantanite (B25..B28)
          quantDocsUploaded: vOrPick('B25', ['documents uploaded','docs uploaded','quant documents uploaded']),
          quantCompaniesCompleted: vOrPick('B26', ['companies completed','companies done','quant companies completed']),
          quantLogosUploaded: vOrPick('B27', ['logos uploaded','quant logos uploaded']),
          quantDocsAddedTo9fin: vOrPick('B28', ['documents added to 9fin','docs added to 9fin','documents to 9fin']),
          // Quantanite totals for progress
          quantTotalCompanies: vOrPick('B1', ['total companies','total','companies total']), // 9016
          quantLatamTotal: vOrPick('B3', ['latam total','latam companies']),                 // 381
          quantIGTotal: vOrPick('F3', ['ig total','ig companies']),                          // 1235
          quantEMTotal: vOrPick('B31', ['em total','em companies']),                         // EM total
          quantCEEMEATotal: vOrPick('B32', ['ceemea total','ceemea companies']),            // CEEMEA total
          quantAPACTotal: vOrPick('B33', ['apac total','apac companies']),                  // APAC total
        };
      }

  // (Removed tasks/KPI rendering per request)

      // --- Weekly Chart: Quantanite companies created per week ---
      function startOfISOWeekUTC(d) {
        // Return a new Date at UTC midnight of the Monday of the ISO week for date d
        const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        const day = date.getUTCDay() || 7; // Sun=0 -> 7
        if (day !== 1) date.setUTCDate(date.getUTCDate() - (day - 1));
        return date;
      }
      function addDaysUTC(d, n) {
        const out = new Date(d.getTime());
        out.setUTCDate(out.getUTCDate() + n);
        return out;
      }
      function formatYYYYMMDDUTC(d) {
        const y = d.getUTCFullYear();
        const m = String(d.getUTCMonth() + 1).padStart(2, '0');
        const day = String(d.getUTCDate()).padStart(2, '0');
        return `${y}-${m}-${day}`;
      }
      function formatDayMonYYYYUTC(d) {
        const day = String(d.getUTCDate()).padStart(2, '0');
        const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        const mon = months[d.getUTCMonth()];
        const y = d.getUTCFullYear();
        return `${day} ${mon} ${y}`;
      }

  function parseQuantaniteWeekly(csvText) {
        const lines = csvText.replace(/\r\n?/g, '\n').split('\n').filter(Boolean);
        if (lines.length < 2) return [];
        // Assume row 1 is header; parse subsequent rows (C is DAILY completions)
        const rows = [];
        for (let i = 1; i < lines.length; i++) {
          const cols = parseCsvLine(lines[i]);
          const dateStr = (cols[0] || '').trim(); // A
          const dailyStr = (cols[2] || '').trim(); // C (daily completed)
          const daily = toNumber(dailyStr);
          const d = new Date(dateStr);
          if (!isNaN(d)) rows.push({ date: d, daily });
        }
        // Sort by date asc
        rows.sort((a,b) => a.date - b.date);
        // Sum duplicates per day (if multiple entries exist for same date)
        const byDay = new Map();
        for (const r of rows) {
          const key = r.date.toISOString().slice(0,10);
          byDay.set(key, (byDay.get(key) || 0) + (r.daily || 0));
        }
        // Build weekly sums from daily totals, keyed by the Friday date of each ISO week
        const days = Array.from(byDay.keys()).sort();
        const dayTotals = days.map(k => ({ key: k, daily: byDay.get(k) }));
        const weekly = new Map(); // key: 'YYYY-MM-DD' (Friday), value: weekly sum
        for (let i = 0; i < dayTotals.length; i++) {
          const cur = dayTotals[i];
          const curDate = new Date(cur.key);
          const monday = startOfISOWeekUTC(curDate);
          const friday = addDaysUTC(monday, 4);
          const fridayKey = formatYYYYMMDDUTC(friday);
          weekly.set(fridayKey, (weekly.get(fridayKey) || 0) + (cur.daily || 0));
        }
        const labels = Array.from(weekly.keys()).sort(); // ISO date strings sort chronologically
        const weeklyRaw = labels.map(k => weekly.get(k) || 0);
        // Make it cumulative over weeks
        const data = [];
        for (let i = 0; i < weeklyRaw.length; i++) {
          data[i] = (i === 0 ? 0 : data[i-1]) + weeklyRaw[i];
        }
        // Sanity: final cumulative should equal sum of all daily values
        const expectedTotal = dayTotals.reduce((acc, d) => acc + (d.daily || 0), 0);
        if (data.length && data[data.length - 1] !== expectedTotal) {
          data[data.length - 1] = expectedTotal;
        }
        // Build pretty labels (exact Friday dates)
        const pretty = labels.map(k => {
          const d = new Date(`${k}T00:00:00Z`);
          return formatDayMonYYYYUTC(d);
        });
        return { labels: pretty, data };
      }

  let weeklyChart;
  let projectionChart;
      function renderWeeklyChart(dataset) {
        try {
          const ctx = document.getElementById('weeklyChart');
          if (!ctx) return;
          if (weeklyChart) { weeklyChart.destroy(); }
          weeklyChart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: dataset.labels,
              datasets: [{
                label: 'Companies Created (weekly)',
                data: dataset.data,
                borderColor: '#00e5a8',
                backgroundColor: 'rgba(0,229,168,0.2)',
                tension: 0.25,
                pointRadius: 2,
                borderWidth: 2,
                fill: true,
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: { mode: 'index', intersect: false },
              },
              interaction: { mode: 'index', intersect: false },
              scales: {
                x: { ticks: { autoSkip: true, maxTicksLimit: 10, font: { size: 10 } }, grid: { display: false } },
                y: { beginAtZero: true, ticks: { font: { size: 10 } }, grid: { color: 'rgba(148,163,184,0.2)' } }
              }
            }
          });
        } catch (e) {
          const note = document.getElementById('weeklyChartNote');
          if (note) note.textContent = 'Failed to render chart.';
          console.error(e);
        }
      }

      async function loadWeeklyFromQuantaniteSheet() {
        try {
          // Hardcode to provided Quantanite published URL (gid=1595767531)
          const url = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQgyZLZ7pfUliJwmvi9z6CzpsE1ZEm4N97Bm6JgeaELaYkDpMX-PLZnrH89w-5HT15zXJLy25mUm3dR/pubhtml?gid=1595767531&single=true';
          const csvText = await fetchPublishedCsv(url);
          const weekly = parseQuantaniteWeekly(csvText);
          renderWeeklyChart(weekly);
          // Initialize projection with selected team size (baseline 3)
          const teamSelect = document.getElementById('teamSizeSelect');
          const initTeam = teamSelect ? (Number(teamSelect.value) || 3) : 3;
          renderProjectionChart(weekly, 9016, initTeam);

          // Re-render projection on team size changes
          if (teamSelect) {
            teamSelect.addEventListener('change', () => {
              const people = Number(teamSelect.value) || 3;
              renderProjectionChart(weekly, 9016, people);
            });
          }
        } catch (e) {
          const note = document.getElementById('weeklyChartNote');
          if (note) note.textContent = e.message || 'Failed to load weekly data.';
          console.error(e);
        }
      }

  function renderProjectionChart(weeklyDataset, targetTotal, teamSize = 3) {
        try {
          const labels = weeklyDataset.labels || [];
          const cumulative = weeklyDataset.data || [];
          if (!labels.length || !cumulative.length) return;
          const lastTotal = cumulative[cumulative.length - 1] || 0;

          // Derive weekly increments from cumulative
          const weeklyIncrements = cumulative.map((v, i) => i === 0 ? v : v - cumulative[i - 1]);
          // Average weekly rate over observed weeks (exclude any zero-length series)
          const observedWeeks = weeklyIncrements.length;
          const baseAvgRate = observedWeeks ? (weeklyIncrements.reduce((a,b)=>a+b,0) / observedWeeks) : 0;
          // Scale projection by team size relative to baseline of 3 people
          const people = Math.max(1, Number(teamSize) || 3);
          const scale = people / 3;
          const avgRate = baseAvgRate * scale;

          // Project forward week-by-week until reaching targetTotal
          const projLabels = [...labels];
          const projData = [...cumulative];
          let current = lastTotal;
          let weekCount = 0;
          while (current < targetTotal && avgRate > 0 && weekCount < 520) { // cap at 10 years
            current = Math.min(targetTotal, current + avgRate);
            // Next Friday label from last known label (parse back to date)
            const lastLabel = projLabels[projLabels.length - 1];
            const [d, mon, y] = lastLabel.split(' ');
            const months = {Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11};
            const lastDate = new Date(Date.UTC(parseInt(y,10), months[mon], parseInt(d,10)));
            const nextFriday = addDaysUTC(lastDate, 7);
            projLabels.push(formatDayMonYYYYUTC(nextFriday));
            projData.push(Math.round(current));
            weekCount++;
          }

          // Set ETA text
          const etaEl = document.getElementById('projectionEta');
          if (etaEl && projLabels.length > labels.length) {
            etaEl.textContent = projLabels[projLabels.length - 1];
          }
          const teamEl = document.getElementById('projectionTeam');
          if (teamEl) teamEl.textContent = String(people);

          const ctx = document.getElementById('projectionChart');
          if (!ctx) return;
          if (projectionChart) projectionChart.destroy();
          projectionChart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: projLabels,
              datasets: [
                {
                  label: 'Observed cumulative',
                  data: cumulative,
                  borderColor: '#00e5a8',
                  backgroundColor: 'rgba(0,229,168,0.1)',
                  pointRadius: 0,
                  borderWidth: 2,
                  tension: 0.25,
                  fill: false,
                },
                {
                  label: 'Projected cumulative',
                  data: projData,
                  borderColor: '#0ea5e9',
                  backgroundColor: 'rgba(14,165,233,0.08)',
                  pointRadius: 0,
                  borderDash: [6,4],
                  borderWidth: 2,
                  tension: 0.25,
                  fill: true,
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: { mode: 'index', intersect: false },
              },
              interaction: { mode: 'index', intersect: false },
              scales: {
                x: { ticks: { autoSkip: true, maxTicksLimit: 10, font: { size: 10 } }, grid: { display: false } },
                y: { beginAtZero: true, ticks: { font: { size: 10 } }, grid: { color: 'rgba(148,163,184,0.2)' } }
              }
            }
          });
        } catch (e) {
          const note = document.getElementById('projectionNote');
          if (note) note.textContent = 'Failed to render projection.';
          console.error(e);
        }
      }

      async function loadFromUrl() {
        clearError();
        const url = (els.url.value || '').trim();
        if (!url) { showError('Please paste your published Google Sheet URL.'); return; }
        try {
          const csv = await fetchPublishedCsv(url);
          // Update only the stat cards (no tasks/KPI rendering)
          updateStats(getStatsFromCsv(csv));
        } catch (e) { console.error(e); showError(e.message || 'Failed to load data.'); }
      }

      els.loadBtn.addEventListener('click', loadFromUrl);
      // Auto-load from prefilled URL; initialize stats first
      updateStats();
      if (els.url && els.url.value) {
        loadFromUrl();
      }
  // Load weekly Quantanite chart
  loadWeeklyFromQuantaniteSheet();
    </script>
  </body>
  </html>
